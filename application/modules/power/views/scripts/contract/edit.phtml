<?php
	$this->title = "BBA Contract Update";
	$this->headTitle($this->title);
?>

<?php if ($this->previousContract instanceof Power_Model_Contract): ?>
<h2>Previous Contract Ref: <?php echo $this->escape(
        $this->previousContract->reference
); ?></h2>
<h2>Previous End Date: <?php echo $this->escape(
        $this->previousContract->dateEnd->toString('dd/MM/yyyy')
); ?></h2>
<?php else: ?>
<h2>No Previous Contract</h2>
<?php endif; ?>

<?php echo $this->contractSaveForm; ?>

<script>
    var meterStore = <?php echo $this->meterStore; ?>;
    var tenderStore = <?php echo $this->tenderStore; ?>;
    dojo.addOnLoad(function(){
        dojo.connect(meterGrid, "onRowDblClick", function(val){
            selectedIndex = meterGrid.focus.rowIndex;
            selectedItem = meterGrid.getItem(selectedIndex);
            //Not sure if this is the most efficient way but it worked for me
            selectedId = meterGrid.store.getValue(selectedItem, "meter_idMeter");

            location.href = '/meter/edit/meterId/' + selectedId;
        });

        dojo.connect(tenderGrid, "onRowDblClick", function(val){
            selectedIndex = tenderGrid.focus.rowIndex;
            selectedItem = tenderGrid.getItem(selectedIndex);
            //Not sure if this is the most efficient way but it worked for me
            selectedId = tenderGrid.store.getValue(selectedItem, "tender_idTender");

            location.href = '/tender/edit/tenderId/' + selectedId;
        });
    });

</script>

<?php echo $this->partial('_table-head.phtml', array(
    'heading'   => 'Meters',
    'label'     => 'New Meter',
    'location'  => $this->url(array(
        'controller'    => 'contract',
        'action'        => 'add-meter',
        'contractId'    => $this->contract->id
    ),'default', true)
)); ?>

<div dojotype="dojo.data.ItemFileReadStore" jsid="meterTableStore" data="meterStore"></div>

<div dojotype="dojo.data.ItemFileReadStore" jsid="tenderTableStore" data="tenderStore"></div>

<table dojoType="dojox.grid.DataGrid"
       jsId="meterGrid"
       store="meterTableStore"
       query="{ meter_idMeter: '*' }"
       style="width: 100%;"
       autowidth="false"
       autoHeight="true"
       rowSelector="10px">
    <thead>
        <tr>
            <th field="meter_idMeter" width="75">Id</th>
            <th field="meter_clientCo_name" width="150">Client Contact</th>
            <th field="meter_clientAd_addressName" width="100">Address</th>
            <th field="meter_clientAd_postcode" width="auto">Postcode</th>
            <th field="meter_numberMain" width="auto">Number Main</th>
        </tr>
    </thead>
</table>

<?php echo $this->partial('_table-head.phtml', array(
    'heading'   => 'Tenders',
    'label'     => 'New Tender',
    'location'  => $this->url(array(
        'controller'    => 'contract',
        'action'        => 'add-tender',
        'contractId'    => $this->contract->id
    ),'default', true)
)); ?>

<table dojoType="dojox.grid.DataGrid"
       jsId="tenderGrid"
       store="tenderTableStore"
       query="{ tender_idTender: '*' }"
       style="width: 100%;"
       autowidth="false"
       autoHeight="true"
       rowSelector="10px">
    <thead>
        <tr>
            <th field="tender_idTender" width="75">Id</th>
            <th field="tender_supplier_name" width=150">Supplier</th>
            <th field="tender_supplierCo_name" width="150">Supplier Contact</th>
            <th field="tender_supplier_phone" width="100">Phone</th>
            <th field="tender_periodContract" width="100">Contract Period</th>
            <th field="tender_dateExpiresQuote" width="100">Quote Expires</th>
            <th field="tender_chargeStanding" width="100">Standing Charge</th>
            <th field="tender_priceUnitDay" width="100">Day Rate</th>
            <th field="tender_priceUnitNight" width="100">Night Rate</th>
            <th field="tender_priceUnitOther" width="100">Other Rate</th>
        </tr>
    </thead>
</table>