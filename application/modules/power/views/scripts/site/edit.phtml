<?php
    $this->title = "BBA Site Update";
    $this->headTitle($this->title);
?>
<div class="ident alpha">
    <p><?php echo $this->escape($this->site->client_name); ?> </p>
    <p><?php echo $this->escape($this->site->clientAd_addressName); ?></p>
    <p><?php echo $this->formatSiteAddress(array(
        $this->escape($this->site->clientAd_address1),
        $this->escape($this->site->clientAd_address2),
        $this->escape($this->site->clientAd_address3),
        $this->escape($this->site->clientAd_postcode)
    )); ?></p>
</div>

<div class="form_wrap ident">
    <?php echo $this->siteEditForm; ?>
</div>

<div class="clear"></div>

<?php echo $this->partial('_table-head.phtml', array(
    'heading'   => 'Meters',
    'label'     => 'New Meter',
    'location'  => $this->url(array(
        'controller'    => 'meter',
        'action'        => 'add',
        'siteId'      => $this->site->id
    ), 'default', true)
)); ?>
<!--
<table>
    <tr>
        <th>Type <span class="id">(id)</span></th>
        <th>Number Serial</th>
        <th>Number Main</th>
        <th>&nbsp;</th>
	</tr>
<?php
	if ($this->meters):
		foreach($this->meters as $meter):
?>
    <tr>
        <td><?php echo $meter->type; ?>&nbsp;
            <span class="id">(<?php echo $this->escape($meter->id); ?>)</span></td>
        <td><?php echo $meter->numberSerial; ?></td>
        <td><?php echo $meter->numberMain; ?></td>
        <td class="action">
            <button dojoType="dijit.form.Button" type="button">
                Usage
                <script type="dojo/method" event="onClick" args="evt">
                    location.href = "<?php echo $this->url(array(
                        'controller'    => 'usage',
                        'action'        => 'add',
                        'siteId'        => $meter->idSite,
                        'meterId'       => $meter->id
                    ), 'default', true); ?>";
                </script>
            </button>

            <button dojoType="dijit.form.Button" type="button">
                Edit
                <script type="dojo/method" event="onClick" args="evt">
                    location.href = "<?php echo $this->url(array(
                        'controller'    => 'meter',
                        'action'        => 'edit',
                        'meterId'       => $meter->id
                    ),'default', true); ?>";
                </script>
            </button>
        </td>
    </tr>
<?php endforeach;
else: ?>
    <tr>
        <td colspan="6">This Site has no meters yet.</td>
    </tr>
<?php endif; ?>
</table>
-->
<script>
    dojo.declare("bba.store", null, {
        constructor: function(/* Object */args){
            dojo.safeMixin(this, args);
        }
    });

    dojo.addOnLoad(function(){
        dojo.connect(dijit.byId("site_idClient"), "onChange", function(val){
            if (dijit.byId("site_idAddress").get('disabled') == true) {
                dijit.byId("site_idAddress").set('disabled', false);
            }
            dijit.byId('site_idAddress').set('value', '');
            dijit.byId('site_idAddressBill').set('value', '');

            bba.clientId = val;
            bba.addressStore = new dojo.data.ItemFileReadStore({
                url:'/site/autocomplete/param/address/addressId/' + bba.store.clientId
            });
            dijit.byId("site_idAddress").store = bba.store.addressStore;
        });

        dojo.connect(dijit.byId("site_idAddress"), "onChange", function(val){
            dijit.byId("site_idAddressBill").set('disabled', false);
            dijit.byId("site_idAddressBill").store = bba.store.addressStore;
        });
    });
</script>

<script>

    function getDelete(item) {
        return '<a href="#" class="button">Usage</button>';
    };

    var meterStore = <?php echo $this->meterStore; ?>;
    dojo.addOnLoad(function(){
        dojo.connect(grid, "onRowClick", function(val){
            selectedIndex = grid.focus.rowIndex;
            selectedItem = grid.getItem(selectedIndex);
            //Not sure if this is the most efficient way but it worked for me
            selectedId = grid.store.getValue(selectedItem, "meter_idMeter");

            var url = '/meter/edit/meterId/' + selectedId;

            location.href = url;
        });
    });

</script>

<div dojotype="dojo.data.ItemFileReadStore" jsid="tableStore" data="meterStore"></div>

<table dojoType="dojox.grid.DataGrid"
       jsId="grid"
       store="tableStore"
       query="{ meter_idMeter: '*' }"
       style="width: 100%;height:500px;"
       autoWidth="false"
       autoHeight="false"
       rowSelector="0px"
       rowsPerPage="25"
       noDataMessage="<span class='dojoxGridNoData'>No records found matching query</span>">
    <thead>
        <tr>
            <th field="meter_idMeter" width="75">Id</th>
            <th field="meter_type" width="100">Type</th>
            <th field="meter_numberSerial" width="200">Number Serial</th>
            <th field="meter_numberMain" width="200">Number Main</th>
            <th field="" width="auto"></th>
        </tr>
    </thead>
</table>